// +FHDR -----------------------------------------------------------------------
// Copyright (c) Silicon Optronics. Inc. 2014
//
// File Name:           ip_yuv422.v
// Author:              Willy Lin
// Version:             $Revision$
// Last Modified On:    2021/11/17
// Last Modified By:    $Author$
//
// File Description:    convert yuv444 to yuv422
//                      
// Clock Domain:         
// -FHDR -----------------------------------------------------------------------
module ip_yuv_422
(
//----------------------------------------------//
// Output declaration                           //
//----------------------------------------------//

output reg                     o_422_vstr,
output reg                     o_422_vend,
output reg                     o_422_hstr,
output reg                     o_422_hend,
output reg                     o_422_dvld,
output reg [15:0]              o_422_data,

//----------------------------------------------//
// Input declaration                            //
//----------------------------------------------//

input                          yuv_422_clk,
input                          yuv_422_rst_n,
input                          i_422_vstr,
input                          i_vend,
input                          i_hstr,
input                          i_hend,
input                          i_dvld,
input [23:0]                   i_data

);

//----------------------------------------------//
// Register & Wire declaration                  //
//----------------------------------------------//
//--------------------------------------------------------data part
wire [7:0]                     yuv_data_y; 
wire [7:0]                     yuv_data_cb;
wire [7:0]                     yuv_data_cr;
reg  [7:0]                     yuv_data_y_q; 
reg  [7:0]                     yuv_data_cb_q;
reg  [7:0]                     yuv_data_cr_q;
wire [7:0]                     yuv_data_cb_mean;
wire [7:0]                     yuv_data_cr_mean;
reg  [7:0]                     yuv_data_cr_mean_q;
wire [7:0]                     yuv_data_cb_cr;
//--------------------------------------------------------counter part 
wire                           sel_cnt_nxt;
reg                            sel_cnt;
wire                           sel_cnt_inc;
wire                           sel_cnt_clr;

//----------------------------------------------//
// Code Descriptions                            //
//----------------------------------------------//
//----------------------------------------------------------------------data part
assign yuv_data_y          = i_data[23:16];
assign yuv_data_cb         = i_data[15:8];
assign yuv_data_cr         = i_data[7:0];
assign yuv_data_cb_mean    = (yuv_data_cb + yuv_data_y_cb_q)[8:1];
assign yuv_data_cr_mean    = (yuv_data_cr + yuv_data_y_cr_q)[8:1];
assign yuv_data_cb_cr      = sel_cnt ? yuv_data_cr_mean_q : yuv_data_cb_mean;
assign o_422_data          = {yuv_data_y_q,yuv_data_cb_cr};
//----------------------------------------------------------------------counter part
assign sel_cnt_nxt         = (sel_cnt_inc ? sel_cnt + 1'b1 : sel_cnt) & !sel_cnt_clr;
assign sel_cnt_inc         = o_422_dvld;
assign sel_cnt_clr         = ~o_422_dvld;

always@(posedge yuv_422_clk or negedge yuv_422_rst_n)begin 
  if(!yuv_422_rst_n) begin 
//-----------------------------------------data
    yuv_data_y_q       <= 8'h00;
    yuv_data_y_cb_q    <= 8'h00;
    yuv_data_y_cr_q    <= 8'h00;
    yuv_data_cr_mean_q <= 8'h00;
//-----------------------------------------counter
    sel_cnt            <= 1'b0;
//-----------------------------------------output 
    o_422_vstr         <= 1'b0;    
    o_422_vend         <= 1'b0;    
    o_422_hstr         <= 1'b0;    
    o_422_hend         <= 1'b0;    
    o_422_dvld         <= 1'b0;    
  end
  else begin 
//-----------------------------------------data
    yuv_data_y_q       <= yuv_data_y;
    yuv_data_y_cb_q    <= yuv_data_y_cb;
    yuv_data_y_cr_q    <= yuv_data_y_cr;
    yuv_data_cr_mean_q <= yuv_data_cr_mean;
//-----------------------------------------counter
    sel_cnt            <= sel_cnt_nxt;
//-----------------------------------------output 
    o_422_vstr         <= i_422_vstr;    
    o_422_vend         <= i_422_vend;    
    o_422_hstr         <= i_422_hstr;    
    o_422_hend         <= i_422_hend;    
    o_422_dvld         <= i_422_dvld;    
  end
end







endmodule
